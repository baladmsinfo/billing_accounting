generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
  SUPERADMIN
  STOREADMIN
}

enum ProductType {
  POS
  BILLING
}

model User {
  id                   String                @id @default(uuid())
  email                String                @unique
  password             String
  apikey               String?               @unique
  name                 String
  role                 Role                  @default(USER)
  status               Boolean               @default(false)
  mobile_verifited     Boolean               @default(false)
  email_verifited      Boolean               @default(false)
  invited              Boolean               @default(false)
  inviteToken          String?
  inviteTokenExpiry    DateTime?
  invoiceItemTimelines InvoiceItemTimeline[]

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Currency {
  id            String  @id @default(uuid())
  code          String  @unique
  name          String
  symbol        String
  country       String
  decimalDigits Int?
  rounding      Int?
  isDefault     Boolean @default(true)

  companies Company[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Company {
  id               String         @id @default(uuid())
  name             String
  tenant           String?        @unique
  shortname        String?
  gstNumber        String?
  privateapiKey    String?        @unique
  publicapiKey     String?        @unique
  productType      ProductType    @default(BILLING)
  users            User[]
  branches         Branch[]
  accounts         Account[]
  journals         JournalEntry[]
  invoices         Invoice[]
  products         Product[]
  items            Item[]
  customers        Customer[]
  taxRates         TaxRate[]
  payments         Payment[]
  stock            StockLedger[]
  categories       Category[]
  invoiceTax       InvoiceTax[]
  vendors          Vendor[]
  carts            Cart[]
  banners          Banner[]
  trial            Boolean        @default(true)
  primaryEmail     String
  secondaryEmail   String?
  primaryPhoneNo   String
  secondaryPhoneNo String?

  logoUrlShort String?
  logoUrlLong  String?

  addressLine1 String
  addressLine2 String?
  addressLine3 String?
  city         String
  state        String
  pincode      Int
  companyType  String

  currencyId String
  currency   Currency @relation(fields: [currencyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Banner {
  id          String  @id @default(uuid())
  title       String?
  description String? // optional
  imageUrl    String // required URL
  manage      Boolean @default(true) // enable/disable banner

  // Company relation
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  // Image relation
  imageId String
  image   Images @relation(fields: [imageId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Branch {
  id           String  @id @default(uuid())
  name         String
  addressLine1 String
  addressLine2 String?
  addressLine3 String?
  city         String?
  state        String?
  pincode      Int?

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  items Item[]

  users User[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, companyId], name: "name_companyId")
}

model Account {
  id        String         @id @default(uuid())
  name      String
  code      String
  type      AccountType
  companyId String
  company   Company        @relation(fields: [companyId], references: [id])
  parentId  String?
  parent    Account?       @relation("AccountParent", fields: [parentId], references: [id])
  children  Account[]      @relation("AccountParent")
  journals  JournalEntry[]
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  INCOME
  EXPENSE
}

model JournalEntry {
  id          String   @id @default(uuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  date        DateTime
  description String
  debit       Float
  credit      Float
  accountId   String
  account     Account  @relation(fields: [accountId], references: [id])
  createdAt   DateTime @default(now())
}

model Category {
  id          String  @id @default(uuid())
  name        String
  description String?

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  parentId String?
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")

  products    Product[] @relation("ParentCategory")
  subProducts Product[] @relation("SubCategory")

  /// One image per Category (optional)
  imageID String? @unique @map("image_id")
  image   Images? @relation(fields: [imageID], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("categories")
}

model Product {
  id          String  @id @default(uuid())
  name        String
  sku         String  @unique
  description String?
  imageUrl    String?
  companyId   String
  company     Company @relation(fields: [companyId], references: [id])

  categoryId String? // Parent category
  category   Category? @relation("ParentCategory", fields: [categoryId], references: [id])

  subCategoryId String? // Child category
  subCategory   Category? @relation("SubCategory", fields: [subCategoryId], references: [id])

  items        Item[]
  invoiceItems InvoiceItem[]
  cartItems    CartItem[]

  images Images[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Payment {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id])

  amount           Float
  method           PaymentMethod
  gatewayPaymentId String?       @unique
  rawResponse      String?
  referenceNo      String? // e.g., UPI txn id, cheque no, etc.
  date             DateTime      @default(now())
  note             String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  UPI
  CHEQUE
  CARD
  OTHER
}

model Item {
  id        String  @id @default(uuid())
  productId String
  product   Product @relation(fields: [productId], references: [id])
  sku       String?
  variant   String?
  price     Float
  MRP       Float?
  quantity  Int     @default(0)
  location  String?
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  invoiceItems InvoiceItem[]
  stock        StockLedger[]
  cartItems    CartItem[]

  taxRateId String?
  taxRate   TaxRate? @relation(fields: [taxRateId], references: [id])

  branches Branch[] // ðŸ‘ˆ Many-to-many

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CustomerAddress {
  id         String   @id @default(uuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  addressLine1 String
  addressLine2 String?
  addressLine3 String?
  city         String
  state        String
  country      String?
  pincode      String?

  isDefault Boolean @default(false) // optional â€” track primary address

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Customer {
  id        String  @id @default(uuid())
  name      String
  email     String?
  phone     String?
  gstin     String?
  companyId String
  password  String?

  company   Company           @relation(fields: [companyId], references: [id])
  invoices  Invoice[]
  carts     Cart[]
  addresses CustomerAddress[] // ðŸ‘ˆ add this line

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum InvoiceType {
  SALE
  POS
  EXPENSE
  ONLINE
  PURCHASE
  RETURN
  OTHER
}

model Cart {
  id         String     @id @default(uuid())
  companyId  String
  company    Company    @relation(fields: [companyId], references: [id])
  customerId String?
  customer   Customer?  @relation(fields: [customerId], references: [id])
  status     CartStatus @default(PENDING)
  items      CartItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum CartStatus {
  DRAFT
  HOLD
  PENDING
  ACTIVE
  CHECKEDOUT
  CANCELLED
}

model CartItem {
  id        String   @id @default(uuid())
  cartId    String
  cart      Cart     @relation(fields: [cartId], references: [id])
  itemId    String
  item      Item     @relation(fields: [itemId], references: [id])
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  quantity  Int
  price     Float
  taxRateId String?
  taxRate   TaxRate? @relation(fields: [taxRateId], references: [id])
  total     Float
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
}

model Vendor {
  id        String    @id @default(uuid())
  name      String
  email     String?
  phone     String?
  address   String?
  gstin     String    @unique
  companyId String
  company   Company   @relation(fields: [companyId], references: [id])
  invoices  Invoice[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Invoice {
  id            String  @id @default(uuid())
  invoiceNumber String
  companyId     String
  company       Company @relation(fields: [companyId], references: [id])

  // Either Customer (SALE) or Vendor (PURCHASE)
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])

  vendorId String?
  vendor   Vendor? @relation(fields: [vendorId], references: [id])

  date        DateTime
  dueDate     DateTime?     @default(now())
  status      InvoiceStatus @default(PENDING)
  type        InvoiceType   @default(SALE)
  expenseImages ExpenseImage[]
  items       InvoiceItem[]
  payments    Payment[]
  invoiceTax  InvoiceTax[]
  totalAmount Float
  taxAmount   Float
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

enum InvoiceStatus {
  PENDING
  PARTIAL
  PAYLATER
  PAID
  CANCELLED
}

model InvoiceTax {
  id          String      @id @default(uuid())
  invoiceId   String
  invoice     Invoice     @relation(fields: [invoiceId], references: [id])
  taxRateId   String
  taxRate     TaxRate     @relation(fields: [taxRateId], references: [id])
  companyId   String
  company     Company     @relation(fields: [companyId], references: [id])
  amount      Float
  invoiceType InvoiceType
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model InvoiceItem {
  id         String                @id @default(uuid())
  invoiceId  String
  invoice    Invoice               @relation(fields: [invoiceId], references: [id])
  itemId     String
  item       Item                  @relation(fields: [itemId], references: [id])
  productId  String
  product    Product               @relation(fields: [productId], references: [id])
  quantity   Int
  price      Float
  status     InvoiceItemStatus     @default(ORDERED)
  taxRateId  String?
  timelines  InvoiceItemTimeline[]
  taxRate    TaxRate?              @relation(fields: [taxRateId], references: [id])
  total      Float
  paidAmount Float                 @default(0)
}

enum InvoiceItemStatus {
  ORDERED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
}

model InvoiceItemTimeline {
  id            String      @id @default(uuid())
  invoiceItemId String
  oldStatus     String?
  newStatus     String
  changedAt     DateTime    @default(now())
  note          String?
  userId        String?
  invoiceItem   InvoiceItem @relation(fields: [invoiceItemId], references: [id])
  user          User?       @relation(fields: [userId], references: [id])

  @@index([invoiceItemId])
}

model TaxRate {
  id        String  @id @default(uuid())
  name      String
  rate      Float
  type      TaxType
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  items Item[]

  invoiceTax   InvoiceTax[]
  cartItems    CartItem[]
  invoiceItems InvoiceItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum TaxType {
  GST
  IGST
  SGST
  CGST
  VAT
}

model StockLedger {
  id        String       @id @default(uuid())
  companyId String
  company   Company      @relation(fields: [companyId], references: [id])
  itemId    String
  item      Item         @relation(fields: [itemId], references: [id])
  date      DateTime     @default(now())
  type      StockTxnType
  quantity  Int
  note      String?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
}

enum StockTxnType {
  PURCHASE
  SALE
  SALE_RETURN
  ADJUSTMENT
}

model ExpenseImage {
  id        String   @id @default(uuid())

  invoiceId String
  invoice   Invoice  @relation(fields: [invoiceId], references: [id])

  imageId   String
  image     Images   @relation(fields: [imageId], references: [id])

  imageUrl  String

  createdAt DateTime @default(now())
}

model Images {
  id       String  @id @default(uuid())
  url      String
  key      String?
  docid    Int?
  filename String?
  mimetype String?
  size     Int?
  expenseImages ExpenseImage[]

  /// Image may belong to ONE category
  category Category?

  banners Banner[]

  /// Still supports product images (optional)
  productId String?
  product   Product? @relation(fields: [productId], references: [id])

  createdAt DateTime @default(now())

  @@map("images")
}
